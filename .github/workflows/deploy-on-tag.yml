name: Deploy on Tag (fast)

on:
  push:
    tags:
      - '*'

concurrency:
  group: deploy-on-tag-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - id: check
        name: Verify tag commit is contained in main
        shell: bash
        run: |
          set -euo pipefail
          echo "Tag: ${GITHUB_REF#refs/tags/} -> $GITHUB_SHA"
          # Fetch just the latest main commit without tags
          git fetch --no-tags --depth=1 origin main
          if git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
            echo "on_main=true" >> "$GITHUB_OUTPUT"
            echo "Tag commit is contained in main. Proceeding."
          else
            echo "on_main=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Tag commit is NOT contained in main. Skipping."
          fi

      - name: Setup Node.js
        if: steps.check.outputs.on_main == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            abroad-ui/package-lock.json
            abroad-server/package-lock.json

      - name: Create .env for UI
        if: steps.check.outputs.on_main == 'true'
        working-directory: abroad-ui
        env:
          UI_DOTENV: ${{ secrets.UI_DOTENV }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
        run: |
          set -euo pipefail
          if [ -z "${UI_DOTENV:-}" ]; then
            echo "::error::UI_DOTENV secret is not set or empty"
            exit 1
          fi
          if [ -z "${VITE_SENTRY_DSN:-}" ]; then
            echo "::error::VITE_SENTRY_DSN secret is not set or empty"
            exit 1
          fi
          # Write exact base contents without interpolation
          printf "%s" "$UI_DOTENV" > .env
          # Ensure frontend Sentry DSN is present for runtime error reporting
          if grep -q '^VITE_SENTRY_DSN=' .env; then
            sed -i "s|^VITE_SENTRY_DSN=.*$|VITE_SENTRY_DSN=${VITE_SENTRY_DSN}|" .env
          else
            printf "\nVITE_SENTRY_DSN=%s\n" "$VITE_SENTRY_DSN" >> .env
          fi

      - name: Install workspace deps
        if: steps.check.outputs.on_main == 'true'
        run: npm ci --no-audit --no-fund

      - name: Build UI
        if: steps.check.outputs.on_main == 'true'
        run: npm -w abroad-ui run build --if-present

      - name: Deploy to Firebase Hosting
        if: steps.check.outputs.on_main == 'true'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
          channelId: live
          entryPoint: abroad-ui
